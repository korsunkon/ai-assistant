# Диагностика проблем с загрузкой звонков

## Проблема: Звонки не загружаются, список не обновляется

### Причина
Backend не запущен или работает некорректно.

### Решение

#### 1. Убедитесь, что запущены ОБА сервера

**Backend** должен работать на порту 8000
**Frontend** должен работать на порту 5173

#### 2. Проверка Backend

Откройте новый терминал и выполните:

```bash
cd project-036-enhanced
curl http://localhost:8000/health
```

**Ожидаемый результат:**
```json
{"status":"ok"}
```

**Если получили ошибку** "Connection refused" или похожую:
- Backend НЕ запущен
- Переходите к пункту 3

#### 3. Запуск Backend

**Способ 1: Автоматический (рекомендуется)**
```bash
cd project-036-enhanced
start_backend.bat
```

**Способ 2: Ручной**
```bash
cd project-036-enhanced
.venv\Scripts\activate
uvicorn backend.app.main:app --reload --port 8000
```

**Проверка после запуска:**
- В консоли должно быть сообщение: "Uvicorn running on http://127.0.0.1:8000"
- Откройте новый терминал и снова проверьте: `curl http://localhost:8000/health`

#### 4. Проверка Frontend

```bash
curl http://localhost:5173
```

**Если получили HTML код** - Frontend работает ✅

**Если ошибка** - запустите Frontend:
```bash
cd project-036-enhanced/frontend
npm run dev
```

#### 5. Проверка CORS и прокси

Если оба сервера запущены, но загрузка не работает:

1. Откройте браузер на `http://localhost:5173`
2. Откройте DevTools (F12)
3. Перейдите на вкладку "Network" (Сеть)
4. Попробуйте загрузить файл
5. Смотрите на запросы:
   - Должен быть запрос к `/api/calls/upload`
   - Статус должен быть 200
   - Если 404 или 500 - смотрите консоль backend
   - Если CORS error - проверьте настройки в `backend/app/main.py`

#### 6. Проверка директорий

Backend нуждается в этих директориях:
```
project-036-enhanced/
├── data/
│   ├── audio/        <- Сюда сохраняются загруженные файлы
│   ├── transcripts/  <- Сюда сохраняются транскрипты
│   └── results/      <- Сюда сохраняются результаты
└── logs/             <- Логи приложения
```

**Проверка:**
```bash
cd project-036-enhanced
ls -la data/
```

**Если папок нет**, создайте их:
```bash
mkdir -p data/audio data/transcripts data/results logs
```

#### 7. Проверка базы данных

```bash
cd project-036-enhanced
ls -la data/app.db
```

**Если файла нет** - это нормально, он создастся при первом запуске Backend.

**Если файл есть**, но проблемы остаются, попробуйте:
```bash
# Создайте backup
cp data/app.db data/app.db.backup
# Удалите базу (будет создана заново)
rm data/app.db
# Перезапустите backend
```

## Пошаговая инструкция запуска с нуля

### Шаг 1: Остановите все процессы
- Закройте все терминалы с запущенными серверами
- Убедитесь, что порты 8000 и 5173 свободны

### Шаг 2: Проверьте структуру
```bash
cd project-036-enhanced
ls -la
# Должны быть: backend/, frontend/, data/, requirements.txt, start.bat
```

### Шаг 3: Создайте директории
```bash
mkdir -p data/audio data/transcripts data/results logs
```

### Шаг 4: Запустите Backend
```bash
start_backend.bat
```

Дождитесь сообщения:
```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### Шаг 5: Проверьте Backend (в новом терминале)
```bash
curl http://localhost:8000/health
# Ожидается: {"status":"ok"}

curl http://localhost:8000/api/calls
# Ожидается: [] (пустой массив)
```

### Шаг 6: Запустите Frontend (в новом терминале)
```bash
start_frontend.bat
```

Дождитесь сообщения:
```
VITE ready in XXX ms
Local: http://localhost:5173/
```

### Шаг 7: Откройте браузер
```
http://localhost:5173
```

### Шаг 8: Тест загрузки
1. Перейдите на страницу "Звонки"
2. Нажмите "Загрузить звонки (MP3/WAV)"
3. Выберите файл
4. Дождитесь сообщения "Файлы загружены"
5. Файл должен появиться в таблице

## Возможные ошибки и решения

### Ошибка 1: "Cannot read properties of undefined"
**Причина:** Frontend загружается быстрее, чем Backend отвечает
**Решение:** Обновите страницу (F5) после запуска Backend

### Ошибка 2: "Network Error" в консоли браузера
**Причина:** Backend не запущен или недоступен
**Решение:** Запустите Backend (см. Шаг 4)

### Ошибка 3: "404 Not Found" при загрузке
**Причина:** Неправильный путь API или Backend не зарегистрировал роутер
**Решение:**
1. Проверьте логи Backend
2. Перезапустите Backend
3. Убедитесь, что в `backend/app/main.py` есть:
   ```python
   app.include_router(calls.router)
   ```

### Ошибка 4: Файлы загружаются, но не отображаются
**Причина:** Проблема с базой данных или SQL запросом
**Решение:**
1. Проверьте логи Backend
2. Попробуйте запросить API напрямую:
   ```bash
   curl http://localhost:8000/api/calls
   ```
3. Если пусто - проблема с сохранением в БД
4. Проверьте права на запись в `data/`

### Ошибка 5: "Module not found" при запуске Backend
**Причина:** Зависимости не установлены
**Решение:**
```bash
cd project-036-enhanced
.venv\Scripts\activate
pip install -r requirements.txt
```

### Ошибка 6: "Port 8000 is already in use"
**Причина:** Другой процесс использует порт 8000
**Решение:**
```bash
# Windows
netstat -ano | findstr :8000
# Найдите PID процесса
taskkill /PID <PID> /F

# Или используйте другой порт
uvicorn backend.app.main:app --reload --port 8001
# И обновите frontend/vite.config.ts
```

## Быстрая проверка системы

Выполните эти команды по порядку:

```bash
# 1. Проверка Backend
curl http://localhost:8000/health
# Ожидается: {"status":"ok"}

# 2. Проверка API звонков
curl http://localhost:8000/api/calls
# Ожидается: [] или список звонков

# 3. Проверка Frontend
curl -I http://localhost:5173
# Ожидается: HTTP/1.1 200 OK

# 4. Проверка директорий
ls -la data/
# Ожидается: audio, transcripts, results

# 5. Проверка БД
ls -la data/app.db
# Должен существовать файл
```

## Контактная диагностика

Если проблема не решается, соберите информацию:

1. **Вывод команд проверки:**
   ```bash
   curl http://localhost:8000/health
   curl http://localhost:8000/api/calls
   ```

2. **Логи Backend:**
   - Последние 20 строк из терминала, где запущен Backend
   - Файл `logs/app.log` (если существует)

3. **Консоль браузера:**
   - Откройте DevTools (F12)
   - Вкладка "Console" - скопируйте ошибки
   - Вкладка "Network" - скопируйте статусы запросов к `/api/calls`

4. **Версии:**
   ```bash
   python --version
   node --version
   npm --version
   ```

---

**Версия:** 2.0 (Enhanced)
**Дата:** 2026-01-16
